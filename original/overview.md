# レイトレーシングプログラム ソース構成

MKRAY.BBBによってビルドされるRAYTRACE.EXEの構成要素と、各ソースファイルの役割について

## ビルド対象ファイル

MKRAY.BBBから特定されるレイトレーシングプログラムの主要ソースファイル：

### C言語ソース

#### RAY1.C
- **役割**: メインプログラム・UI制御
- **主要機能**:
  - プログラムのエントリーポイント（main関数）
  - コマンドライン引数処理とユーザーインターフェース
  - シーンデータファイルの読み込みと解析
  - BMP画像ヘッダーの生成
  - プリミティブ（立体図形）の座標変換・前処理
  - 回転行列の計算
  - ファイル入出力制御

#### RAY3.VC (.c に変換される)
- **役割**: テクスチャマッピング
- **主要機能**:
  - 標準テクスチャパターンの実装
  - `stripe()`: 縞模様テクスチャ
  - `ring()`: 同心円状テクスチャ  
  - `dot()`: ドット模様テクスチャ
  - 表面の色彩計算とパターン生成

### アセンブリソース

#### RAY2.MAC (.asmに変換される)
- **役割**: 高次レベル処理ルーチン
- **主要機能**:
  - `MAINLOOP`: メインレンダリングループ
  - `TRACE`: レイトレーシング本体の処理
  - `SEARCH`: 光線と物体の交点探索
  - `DIFFUSE`: 拡散反射・ハイライト・影付け
  - 光線の反射・屈折計算
  - 色の蓄積・合成処理
  - スクリーン座標から3D空間への変換

#### RAY4.ASM
- **役割**: 低次レベル数値計算関数
- **主要機能**:
  - `NRMLIZE`: ベクトル正規化
  - `LINEAR`: 直線計算（点 + 方向×距離）
  - `ROT/ROT2`: 回転変換サポート
  - `INOUT`: 点の内外判定
  - `SOLVE`: 方程式解法（光線と物体の交点計算）
  - `NORMAL`: 法線ベクトル生成
  - `IRANGE/NRANGE`: 範囲プリミティブの判定
  - `TEXTMAP/BUMPMAP`: テクスチャ・バンプマッピング制御

#### REALA.ASM
- **役割**: 浮動小数点演算ライブラリ
- **主要機能**:
  - 独自REAL型（指数部1バイト、符号1バイト、仮数部2バイト）の実装
  - `FADD/FSUB`: 実数の加算・減算
  - `FMLT/FDIV`: 実数の乗算・除算
  - `FSQRT/FSQAR`: 平方根・二乗計算
  - `FLOG/FEXP`: 対数・指数関数（対数テーブル使用）
  - `FCOMP`: 実数比較
  - `FSCALE`: 指数調整（2のべき乗倍）
  - `ITOR/RTOI`: 整数⇔実数変換
  - 高精度数値計算の基盤を提供

## アーキテクチャ概要

### レンダリングフロー
1. **RAY1.C**: データ読み込み、初期化
2. **RAY2.MAC**: スクリーン各ピクセルに対しレイトレーシング実行
3. **RAY4.ASM**: 数値計算（交点・法線・変換）
4. **RAY3.VC**: 表面特性（テクスチャ）の計算
5. **RAY1.C**: 結果をBMPファイルに出力

### 数値計算アーキテクチャ
- **REALA.ASM**が提供する独自REAL型実数演算を基盤とした高精度計算
- 4バイト構造：指数部(1) + 符号部(1) + 仮数部(2)
- 対数・指数テーブル（SEGLG1/SEGEX1セグメント）による高速演算
- オーバーフロー・アンダーフロー・ゼロ除算の適切な処理
- 全ての幾何・光学計算でこの実数型を使用

### 対応する立体図形
- 立方体（CUBE）
- 平面（PLANE） 
- 二次曲面（SECOND）
- 円錐（CONE）

### 光学効果
- 反射・屈折
- 影付け
- ハイライト
- テクスチャマッピング
- バンプマッピング

このアーキテクチャにより、1985年当時のPC環境でもリアルタイムに近い高品質なレイトレーシング画像の生成を実現していた。
