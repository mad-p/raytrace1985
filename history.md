# 1985年ごろにレイトレを作った

## 背景

TSG(東京大学理論科学グループ)の1年上の先輩達が、
1984年に512 x 512 x 24bitカラーのフレームバッファを作った。
68000がメインCPUで、8インチフロッピーでCP/M 68kが走っていた。
それを使ってCGを表示すべく、スキャンライン法のレンダラなどが作られていた。

1985年は、そのフレームバッファで表示したものをビデオのコマ録りにして
CGアニメーションを作ろうという気運だった。

## レイトレの始まり

山本強先生の本にBASICのレイトレーシングのコードといくつかのサンプルモデルが
掲載されていた。

CQ出版社 「THE 3 DIMENSIONAL COMPUTER GRAPHICS パソコンによる3次元グラフィックスの実際」 山本強

TSGの先輩がこのBASICをCに書き直したコードがあった。
自分も高校生のときにこの本のプログラムを打ち込んで実行していたので、
元プログラム自体にもなじみがあった。

## 8087がない

当時のPC-9801はインテル8086で動いていた。8086には浮動小数点演算機能がなく、
外付の8087という「コプロセッサ」を装着することで提供される仕組みだった。
PC-9801にも8087セットが提供されていたが、当時の価格で10万円程度と高価だったため、
どこにでも8087があるわけではなかった。8087のないマシンでは割込でフックして
ソフトウェアで浮動小数点演算を行っていたと思う。

さて、このCプログラムで8087がない状態で512 x 512の画像をレイトレでレンダリングすると、
約10時間を要した。先輩から「10倍速くして。8087なしで」との要望を受けたのであった。

CGアニメーションにするには多くのコマを計算しなければならない。
単純並列で計算するにしても、大学内のいろんな研究室のPC-9801を夜間に
お借りする必要があった(実際にいく晩も泊まり込んでフロッピーディスクを交換した)。
このような形態で使わせていただく98には通常、8087も拡張メモリもHDDも装備されていない。
買ってきたままの98と5インチフロッピー2枚でシステムが動く必要があった。

## 計算を速くする

8087がない状態では、通常のレイトレで使われる高速化技法、bounding boxや
voxel分割などでは十分な高速化にならないと考えた。
そこで「精度を落として速い浮動小数点演算ルーチンを作ろう」という方針にした。

アイディアはあった。対数表と指数表を持っておき、乗除算を対数の加減算で行う。
当時は2次曲面の組み合わせでモデルを作っていた(CSGモデル)ので、
解の公式に出てくる平方根の計算が、「対数を取って1ビットシフト」で
できるのも魅力であった。

64KBの対数表と指数表を使って、仮数部15bitの浮動小数点演算ルーチンを
アセンブラで作成した。対数表と指数表は頭初PC-9801のグラフィックメモリに置いていた。
実はグラフィックメモリはCRTCからもアクセスされる都合上、
アクセス時にwaitがかかり、計算速度上は不利、ということは後になってから知った。

それでまあ、興が乗ってしまって、レイトレーシングのメインループを全部
アセンブラで書いた。ほぼアセンブラルーチンで完結している。
一部、ファイル入出力、テクスチャマッピングやバンプマッピングで
三角関数が必要になる部分などはCで書いた。

メインループ部分は整数加減算とシフトだけでできている。
結果として、以前のCバージョンに比べて10倍速くなり、
8087相等のスピードが達成できた。

## 精度は足りたのか

仮数部16ビット、ただしhidden 1を使わなかったので実質は15ビット。
10進数にして5ケタくらいの精度はあったようだ。それでも、一部のモデルでは
精度不足からヒットするはずのrayがヒットしなかったり、ということが発生した。
その部分は色がつくはずの1ドットが黒くなる現象としてレンダリング結果に出てしまい、
「黒ゴマ」現象と呼ばれた。

他に、鏡面の性質を持つ物体が接近しているところでは無限に反射が起こり、
色モデルも稚拙なものだったこともあって輝度が1を超えて白い点となる
エラーピクセルも発生した。これは「白ゴマ」と呼ばれていた。
当時の計算ルーチンを正確に再現した今回のCプログラムでも、
以前と同様の白ゴマ・黒ゴマは発生する。

土星の輪を模したモデルは、輪の部分で黒ゴマ現象が頻発、本物の土星の輪のような
効果になってしまい、かえってよいという評価をもらったこともあった(それも今回再現)。

## アニメーション

製作した3D CGアニメーションは、ポリゴンレンダリングによる竜が誕生し、
空へ上っていくというショートストーリーだった。レイトレーシングの出番はあまりなく、
タイトルでTSGのロゴが登場する部分と、竜の誕生シーンでハレーションを起こす
光の球の部分に使われた。

こうしてコマ録りアニメは完成したのだが、その経緯を当時の
PIXEL誌(図形処理情報センター)に寄稿した。上述の白ゴマ・黒ゴマの話も書いた。
TSGの短期連載という形でハードウェアの話から竜の動き、レイトレの話など、
部員が持ち回りで執筆したと思う。

翌年、フレームバッファ上でCRTCのレジスタを操作して、
画面を20分割してループアニメーションできるプログラムを作った。
何人かの人にループアニメを作ってもらい、そこそこ楽しんでもらえたと思う。

## 交流

ちょうどその1985年ごろ、阪大や京大のマイコンクラブでもCGをやっており、
[DoGA](https://doga.jp/2010/general/about.html)が設立された。
これから3D CGをやっていくにあたって、モデルデータを
交換しやすいようにフォーマットを決めようということで、ポリゴンモデルを関西組、
レイトレ向きのCSGモデルを関東組で草案を作る、というような交流があった。
これが縁でDoGA CGAコンテスト上映会のボランティアにも参加したのは後の話である。

----
前田 薫
2025年9月
